function mixin(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i}function prettyTime(e){e=e||0;var t=e%60|0,i=e/60%60|0,n=e/3600|0;return n?n+":"+("0"+i).substr(-2)+":"+("0"+t).substr(-2):i+":"+("0"+t).substr(-2)}function isNullOrUndef(e){return null===e||void 0===e}function EnumerationValue(e,t){this.name=t,this.ownerEnum=e}function Enumeration(e){if(!Array.isArray(e))throw new Error("No values specified for the Enumeration");for(var t=0;t<e.length;t++)this[e[t]]=new EnumerationValue(this,e[t])}function Sprite(e){e=e||{},this.img=e.img?e.img:null,this.sizeX=isNullOrUndef(e.sizeX)?isNullOrUndef(e.size)?1:e.size:e.sizeX,this.sizeY=isNullOrUndef(e.sizeY)?isNullOrUndef(e.size)?1:e.size:e.sizeY}function GameObject(e){e=e||{};var t=null;Object.defineProperty(this,"parent",{get:function(){return t},set:function(e){return t!==e&&(null!==t&&t.children.splice(t.children.indexOf(this),1),t=e,t&&t.children.push(this)),e}}),this.addChildren=function(){for(var e=0;e<arguments.length;e++)arguments[e].parent=this},Object.defineProperty(this,"addChildren",{enumerable:!1}),this.visible=!!isNullOrUndef(e.visible)||e.visible,this.opacity=isNullOrUndef(e.opacity)?1:e.opacity,this.children=[],this.position=new NATH.Vec2(e.position),this.orientation=e.orientation||0,this.sprite=e.sprite||null,this.shape=e.shape||null,this.shapeColor=e.shapeColor||"white",this.shapeStrokeColor=e.shapeStrokeColor||"black",this.drawBehindParent=!isNullOrUndef(e.drawBehindParent)&&e.drawBehindParent,this.shapeOutline=!isNullOrUndef(e.shapeOutline)&&e.shapeOutline,this.shapeFill=!!isNullOrUndef(e.shapeFill)||e.shapeFill,this.shapeLineWidth=isNullOrUndef(e.shapeLineWidth)?.05:e.shapeLineWidth}function Vehicle(e){e=e||{},GameObject.call(this,e),this.frtWheelDst=isNullOrUndef(e.frtWheelDst)?3.7:e.frtWheelDst,this.bckWheelDst=isNullOrUndef(e.bckWheelDst)?3.7:e.bckWheelDst,this.length=isNullOrUndef(e.length)?12:e.length,this.width=isNullOrUndef(e.width)?2.5:e.width,this.wheelConeAngle=isNullOrUndef(e.wheelConeAngle)?85:e.wheelConeAngle,this.wheelOrientSpeed=isNullOrUndef(e.wheelOrientSpeed)?1/700:e.wheelOrientSpeed,this.wheelOrientation=isNullOrUndef(e.wheelOrientation)?0:e.wheelOrientation,this.engineForce=isNullOrUndef(e.engineForce)?0:e.engineForce,this.enginePing=isNullOrUndef(e.enginePing)?2:e.enginePing,this.brakeForce=isNullOrUndef(e.brakeForce)?.9:e.brakeForce,this.acceleration=isNullOrUndef(e.acceleration)?1/700:e.acceleration,this.speed=0,this.maxSpeed=isNullOrUndef(e.maxSpeed)?20:e.maxSpeed,this.shape=new NATH.Rect2(this.length,this.width),this.shapeColor="#ddd",this.shapeOutline=!0;var t=new NATH.Rect2(.9,.4);this.leftBackWheelObj=new GameObject({shape:t,shapeColor:"#111",position:[-this.frtWheelDst,this.width/2],drawBehindParent:!0}),this.leftFrontWheelObj=new GameObject({shape:t,shapeColor:"#111",position:[this.bckWheelDst,this.width/2],drawBehindParent:!0}),this.rightBackWheelObj=new GameObject({shape:t,shapeColor:"#111",position:[-this.frtWheelDst,-this.width/2],drawBehindParent:!0}),this.rightFrontWheelObj=new GameObject({shape:t,shapeColor:"#111",position:[this.bckWheelDst,-this.width/2],drawBehindParent:!0}),this.hasGazzed=!1,this.addChildren(this.leftBackWheelObj,this.rightBackWheelObj,this.leftFrontWheelObj,this.rightFrontWheelObj)}var TLS={loadFile:function(e,t,i,n){n=n||this;var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType=t,o.onload=function(){if(200!==o.status)throw new Error("XMLHttpRequest to "+e+" failed: "+o.status+" "+o.statusText);i.call(n,o.response)},o.onprogress=function(t){console.log("Loading "+e+": "+Math.floor(t.loaded/t.total*100)+"%")},o.send()},loadFiles:function(e,t,i,n){n=n||this;var o=0,s=[];if("string"==typeof t){var r=t;t=Array(e.length);for(var h=0;h<t.length;h++)t[h]=r}e.forEach(function(e,r,h){TLS.loadFile(e,t[r],function(e){o++,s[r]=e,o===h.length&&i.call(n,s)})})},keyCodes:{zero:48,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,break:3,backspace:8,tab:9,clear:12,enter:13,shift:16,ctrl:17,alt:18,pause:19,capsLock:20,escape:27,spacebar:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,print:42,execute:43,printScreen:44,insert:45,delete:46,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,numpadZero:96,numpadOne:97,numpadTwo:98,numpadThree:99,numpadFour:100,numpadFive:101,numpadSix:102,numpadSeven:103,numpadEight:104,numpadNine:105,multiply:106,add:107,subtract:109,decimalPoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,f13:124,f14:125,f15:126,f16:127,f17:128,f18:129,f19:130,numLock:144,scrollLock:145,semiColon:186,equalSign:187,comma:188,dash:189,period:190,forwardSlash:191,graveAccent:192,openBracket:219,backSlash:220,closeBracket:221,singleQuote:222,altgr:225,toggleTouchpad:255},gamepads:function(){var e=[];return window.addEventListener("gamepadconnected",function(t){console.log("Gamepad connected: "+t.gamepad.id),e.push(t.gamepad)}),e}(),isKeyDown:function(){var e=[];return window.addEventListener("keydown",function(t){t.preventDefault(),e[t.keyCode]=!0}),window.addEventListener("keyup",function(t){t.preventDefault(),e[t.keyCode]=!1}),function(t){return!!e[t]}}()};Object.prototype.watch||Object.defineProperty(Object.prototype,"watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,t){var i=this[e],n=i,o=function(){return n},s=function(o){return i=n,n=t.call(this,e,i,o)};delete this[e]&&Object.defineProperty(this,e,{get:o,set:s,enumerable:!0,configurable:!0})}}),Object.prototype.unwatch||Object.defineProperty(Object.prototype,"unwatch",{enumerable:!1,configurable:!0,writable:!1,value:function(e){var t=this[e];delete this[e],this[e]=t}}),CanvasRenderingContext2D.prototype.roundRect=function(e,t,i,n,o){return o=Math.max(o,0),0===o?(this.beginPath(),void this.rect(e,t,i,n)):(i<2*o&&(o=i/2),n<2*o&&(o=n/2),this.beginPath(),this.moveTo(e+o,t),this.arcTo(e+i,t,e+i,t+n,o),this.arcTo(e+i,t+n,e,t+n,o),this.arcTo(e,t+n,e,t,o),this.arcTo(e,t,e+i,t,o),void this.closePath())},EnumerationValue.prototype.toJSON=function(){return this.name},EnumerationValue.prototype.toString=EnumerationValue.prototype.toJSON,Vehicle.prototype=mixin(GameObject.prototype,{actionOrientWheels:function(e,t){this.wheelOrientation+=(e*this.wheelConeAngle/2-this.wheelOrientation)*this.wheelOrientSpeed*t,this.wheelOrientation=NATH.clamp(this.wheelOrientation,-this.wheelConeAngle/2,this.wheelConeAngle/2),this.leftFrontWheelObj.orientation=this.rightFrontWheelObj.orientation=this.wheelOrientation},actionGaz:function(e,t){this.engineForce=NATH.lerp(this.engineForce,e,this.enginePing*(t/1e3)),this.hasGazzed=!0},actionBrake:function(e,t){this.speed=NATH.lerp(this.speed,0,this.brakeForce*NATH.clamp(e,0,1)*(t/1e3)),this.engineForce=NATH.lerp(this.engineForce,0,this.enginePing*(t/1e3)),this.speed<.1&&(this.speed=0),this.engineForce<.002&&(this.engineForce=0)},applyForces:function(){var e=new NATH.Vec2,t=new NATH.Vec2,i=new NATH.Vec2,n=new NATH.Vec2;return function(o){this.getDirection(i),this.hasGazzed||(this.engineForce=NATH.lerp(this.engineForce,0,this.enginePing/8*(o/1e3))),this.speed=NATH.lerp(this.speed,this.maxSpeed*this.engineForce,this.acceleration),n.set(i).mul(this.speed*(o/1e3)),e.set(this.position).sub(i.x*this.bckWheelDst,i.y*this.bckWheelDst),t.set(this.position).add(i.x*this.frtWheelDst,i.y*this.frtWheelDst),e.add(n),t.add(n.rotateDeg(this.wheelOrientation)),this.orientation=NATH.toDegrees(e.vectorTo(t).angle()),this.position.set(e.add(t).div(2)),this.hasGazzed=!1}}(),getDirection:function(e){return e=e||new NATH.Vec2,e.set(Math.cos(NATH.toRadians(this.orientation)),Math.sin(NATH.toRadians(this.orientation)))}}),Vehicle.prototype.constructor=Vehicle;var AudioContext=window.AudioContext||window.webkitAudioContext;window.addEventListener("load",function(){function e(){a=Date.now(),r=a-h,n.width==n.clientWidth&&n.height==n.clientHeight||(n.width=n.clientWidth,n.height=n.clientHeight,aspect=n.width/n.height,l=Math.min(n.width,n.height),d=n.width/l,c=n.height/l),g=TLS.gamepads[0],g&&"xinput"===g.id?(g.buttons[7].pressed&&f.actionGaz(g.buttons[7].value,r),g.buttons[6].pressed&&f.actionGaz(-g.buttons[6].value,r),f.actionOrientWheels(-g.axes[0],r),g.buttons[1].pressed&&f.actionBrake(1,r)):(TLS.isKeyDown(TLS.keyCodes.up)&&f.actionGaz(1,r),TLS.isKeyDown(TLS.keyCodes.down)&&f.actionGaz(-1,r),TLS.isKeyDown(TLS.keyCodes.left)&&f.actionOrientWheels(1,r),TLS.isKeyDown(TLS.keyCodes.right)&&f.actionOrientWheels(-1,r),TLS.isKeyDown(TLS.keyCodes.spacebar)&&f.actionBrake(1,r)),f.applyForces(r),w(),h=a,i(e)}function t(){if(!n||!o||!s)throw alert("Your browser isn't compatible"),new Error("Couldn't initialize");n.width=document.body.clientWidth,n.height=document.body.clientHeight,aspect=n.width/n.height,l=Math.min(n.width,n.height),d=n.width/l,c=n.height/l,p.addChildren(f),e()}var i=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},n=document.getElementById("cvs"),o=n.getContext("2d"),s=new AudioContext,r=0,h=Date.now(),a=Date.now(),l=0,d=0,c=0,u=1/70,p=new GameObject,f=new Vehicle,g=null,w=function(){function e(e,t){var i=3;o.save(),o.translate(e,t),o.fillStyle="#eee",o.strokeStyle="#444",o.lineWidth=.1,o.beginPath(),o.roundRect(0,0,80,80,i),o.moveTo(3,3),o.lineTo(3,77),o.lineTo(77,77),o.lineTo(77,3),o.fill(),o.stroke(),o.fillStyle="#aaa",o.lineWidth=.5,o.strokeStyle="#777",o.beginPath(),o.roundRect(2,2,76,76,1),o.fill(),o.stroke(),o.strokeStyle="#fa1",o.lineWidth=.2,o.beginPath(),o.moveTo(89.8,0),o.lineTo(89.8,80),o.moveTo(90.2,0),o.lineTo(90.2,80),o.moveTo(0,89.8),o.lineTo(80,89.8),o.moveTo(0,90.2),o.lineTo(80,90.2),o.stroke(),o.strokeStyle="#eee",o.lineWidth=.8,o.beginPath(),o.moveTo(79.5,89.6),o.lineTo(79.5,80.2),o.moveTo(90.6,79.5),o.lineTo(99.8,79.5),o.moveTo(80.2,.5),o.lineTo(89.5,.5),o.moveTo(.5,90.5),o.lineTo(.5,99.8),o.stroke(),o.strokeStyle="#eee",o.lineWidth=.2,o.save(),o.setLineDash([2,6]),o.beginPath(),o.moveTo(0,86.5),o.lineTo(78,86.5),o.moveTo(3,93.5),o.lineTo(80,93.5),o.moveTo(86.5,80),o.lineTo(86.5,3),o.moveTo(93.5,78),o.lineTo(93.5,3),o.stroke(),o.restore(),o.strokeStyle="#eee",o.lineWidth=.2,o.save(),o.beginPath(),o.moveTo(3,83),o.lineTo(78,83),o.moveTo(3,97),o.lineTo(77,97),o.moveTo(83,77),o.lineTo(83.5,3),o.moveTo(97,78),o.lineTo(97,3),o.stroke(),o.restore(),o.restore()}function t(t,i,n,s){Math.floor(-t),Math.floor(-i),Math.ceil(t),Math.ceil(i);o.save();for(var r=-2;r<2;r++)for(var h=-2;h<2;h++)e(100*Math.round(n/100)+100*r-n,100*Math.round(s/100)+100*h-s);o.restore()}function i(e){if(e.visible){o.save(),o.translate(e.position.x,e.position.y),o.rotate(NATH.toRadians(e.orientation)),o.globalAlpha=e.opacity;for(var t=0;t<e.children.length;t++)e.children[t].visible&&e.children[t].drawBehindParent&&i(e.children[t]);if(o.fillStyle=e.shapeColor,o.strokeStyle=e.shapeLineColor,o.lineWidth=e.shapeLineWidth,e.sprite)e.sprite.img&&o.drawImage(img,-e.sprite.sizeX/2,-e.sprite.sizeY/2,e.sprite.sizeX,e.sprite.sizeY);else if(e.shape&&e.shape.vertices.length>=6){o.beginPath(),o.moveTo(e.shape.vertices[0],e.shape.vertices[1]);for(var t=2;t<e.shape.vertices.length;t+=2)o.lineTo(e.shape.vertices[t],e.shape.vertices[t+1]);o.closePath(),e.shapeFill&&o.fill(),e.shapeOutline&&o.stroke()}for(var t=0;t<e.children.length;t++)e.children[t].visible&&!e.children[t].drawBehindParent&&i(e.children[t]);o.restore()}}function s(e,t,i,n){o.beginPath(),o.moveTo(e,t),o.arc(e+i/2,t,i/2,Math.PI,NATH.PI2),o.closePath(),o.fill(),o.stroke(),o.beginPath(),o.moveTo(e+i/2,t-i/30),o.lineTo(e+i/2+Math.cos(Math.PI+n*Math.PI)*i*.45,t+Math.sin(Math.PI+n*Math.PI)*i*.45-i/30),o.stroke()}function r(){o.save(),o.strokeStyle="black",o.fillStyle="white",s(10,n.height-10,200,Math.abs(f.engineForce)),s(n.width-210,n.height-10,200,Math.abs(f.speed/f.maxSpeed)),o.restore()}return function(){o.clearRect(0,0,n.width,n.height),o.fillStyle="gray",o.fillRect(0,0,n.width,n.height),o.save(),o.translate(n.width/2,n.height/2),o.scale(l*u,-l*u),t(1e3,1e3,f.position.x,f.position.y),o.translate(-f.position.x,-f.position.y),i(p),o.translate(f.position.x,f.position.y),o.restore(),r()}}();t()});